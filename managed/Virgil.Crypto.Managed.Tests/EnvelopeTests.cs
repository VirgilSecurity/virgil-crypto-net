using System.Collections.Generic;
using System.Linq;
using Org.BouncyCastle.Asn1;
using Virgil.SDK.Cryptography.ASN1.Models;
using Xunit;

namespace Virgil.SDK.Cryptography.Tests
{
	public class EnvelopeTests
	{
		[Fact]
		public void Parse()
		{
			var data = "308201FA020100308201F306092A864886F70D010703A08201E4308201E0020102318201B130820113020102A022042094DCEEEFF69664EF8A3CD84B46EFD8FFAD2225BA21BB33E0F5EC0656500204EB300506032B65700481E23081DF020100302A300506032B657003210071C058D9B008B3D6E97A37E844D158E8E5C291F8BBBD92912749E1CD75C732DB3018060728818C71020502300D060960864801650304020205003041300D060960864801650304020205000430498D5EC673CC89080D69158CFF8C84DBC94DED8C3CBDEEFC9385A65733385942E4A8CF12C27E1D0389A602A2E448AA003051301D060960864801650304012A041015F3E2CEFAB6C12907A4CBF62D5D91D30430D6F0CFA9BFE0C0DD1F8AF978245DDF434E8319B02CDA16AB53AFEC3D9D16F631F2A66DABB970A3318E0BF2BEDDB08A9CA38197308194020100305D06092A864886F70D01050D3050302F06092A864886F70D01050C302204101DA7ECD2B9C975BECF3D63718FE81A4B02021EAC300A06082A864886F70D020A301D060960864801650304012A041016D6E59A90A6D417F26337449BD0FD170430A90DD3CAA491406F72047A3C36B1717B7950528DC5062EC62891E612A25A9B166C62B9223A75D4FA8EBDE9ED0309133F302606092A864886F70D0107013019060960864801650304012E040CBA53BCA050B80D9EB7A1C9BF".ToBytes();
			var envelop = Envelope.GetInstance(Asn1Object.FromByteArray(data));

			Assert.NotNull(envelop.Nonce);
			var recipients = envelop.Recipients.ToArray();
			Assert.Equal(2,recipients.Length);
			Assert.IsType<PasswordRecipient>(recipients[1]);
			Assert.IsType<PublicKeyRecipient>(recipients[0]);
		}

		[Fact]
		public void Compose()
		{
			var expected = "308201FA020100308201F306092A864886F70D010703A08201E4308201E0020102318201B130820113020102A022042094DCEEEFF69664EF8A3CD84B46EFD8FFAD2225BA21BB33E0F5EC0656500204EB300506032B65700481E23081DF020100302A300506032B657003210071C058D9B008B3D6E97A37E844D158E8E5C291F8BBBD92912749E1CD75C732DB3018060728818C71020502300D060960864801650304020205003041300D060960864801650304020205000430498D5EC673CC89080D69158CFF8C84DBC94DED8C3CBDEEFC9385A65733385942E4A8CF12C27E1D0389A602A2E448AA003051301D060960864801650304012A041015F3E2CEFAB6C12907A4CBF62D5D91D30430D6F0CFA9BFE0C0DD1F8AF978245DDF434E8319B02CDA16AB53AFEC3D9D16F631F2A66DABB970A3318E0BF2BEDDB08A9CA38197308194020100305D06092A864886F70D01050D3050302F06092A864886F70D01050C302204101DA7ECD2B9C975BECF3D63718FE81A4B02021EAC300A06082A864886F70D020A301D060960864801650304012A041016D6E59A90A6D417F26337449BD0FD170430A90DD3CAA491406F72047A3C36B1717B7950528DC5062EC62891E612A25A9B166C62B9223A75D4FA8EBDE9ED0309133F302606092A864886F70D0107013019060960864801650304012E040CBA53BCA050B80D9EB7A1C9BF".ToBytes();
			var passwordRecipient = Asn1Object.FromByteArray("a38197308194020100305d06092a864886f70d01050d3050302f06092a864886f70d01050c302204101da7ecd2b9c975becf3d63718fe81a4b02021eac300a06082a864886f70d020a301d060960864801650304012a041016d6e59a90a6d417f26337449bd0fd170430a90dd3caa491406f72047a3c36b1717b7950528dc5062ec62891e612a25a9b166c62b9223a75d4fa8ebde9ed0309133f".ToBytes());
			var publicKeyRecipient = Asn1Object.FromByteArray("30820113020102a022042094dceeeff69664ef8a3cd84b46efd8ffad2225ba21bb33e0f5ec0656500204eb300506032b65700481e23081df020100302a300506032b657003210071c058d9b008b3d6e97a37e844d158e8e5c291f8bbbd92912749e1cd75c732db3018060728818c71020502300d060960864801650304020205003041300d060960864801650304020205000430498d5ec673cc89080d69158cff8c84dbc94ded8c3cbdeefc9385a65733385942e4a8cf12c27e1d0389a602a2e448aa003051301d060960864801650304012a041015f3e2cefab6c12907a4cbf62d5d91d30430d6f0cfa9bfe0c0dd1f8af978245ddf434e8319b02cda16ab53afec3d9d16f631f2a66dabb970a3318e0bf2beddb08a9c".ToBytes());
			var actual = new Envelope(new[]
				{					
					publicKeyRecipient,
					passwordRecipient,
				},
				new Nonce("BA53BCA050B80D9EB7A1C9BF".ToBytes()))
			.GetDerEncoded();

			Assert.Equal(expected,actual);
		}

		[Fact]
		public void ParseSign()
		{
			var data = "308201D40201003082015906092A864886F70D010703A082014A308201460201023182011730820113020102A0220420A6953E6E23C84DF0CA3F71311C667B32AD3EF9D8A1D2A0862CFB246A65EC9006300506032B65700481E23081DF020100302A300506032B6570032100A654BBFE38E1C560A0C35E3E2C02B601839A3AC36C4657F5046016E68F9BF6FA3018060728818C71020502300D060960864801650304020205003041300D06096086480165030402020500043013B582327ECC7B6391E166623118A65E1094538FE5C3D7C3F0F485FB26B11A2C0520C86C101D80DE53E1A9DED7E4C3693051301D060960864801650304012A0410D3F5AF35C92766FFFA6A71890C2C9B6504305DAEB2B35CE367446CCFC079E6B0B1E6131FC9576BBD651AE931C2BA8C79CBBE868A329C2DDB45D44D78024C24AA8582302606092A864886F70D0107013019060960864801650304012E040C2535508A144DC510628FD57BA0723170306E0C1556495247494C2D444154412D5349474E4154555245A25504533051300D060960864801650304020205000440D89A7967C64B0F51177BD426AA551C0545158DE25D6178BBEAEF2F722A7238A43B147BCDA80548F31095CA05DAB8201671D73AA55C6A984A6DB25458CA406E00".ToBytes();
			var expected = "3051300D060960864801650304020205000440D89A7967C64B0F51177BD426AA551C0545158DE25D6178BBEAEF2F722A7238A43B147BCDA80548F31095CA05DAB8201671D73AA55C6A984A6DB25458CA406E00".ToBytes();
			var envelop = Envelope.GetInstance(data);
			Assert.True(envelop.CustomParams.ContainsKey("VIRGIL-DATA-SIGNATURE"));
			Assert.Equal(expected,envelop.CustomParams["VIRGIL-DATA-SIGNATURE"]);
		}

		[Fact]
		public void ComposeSign()
		{
			var expected = "308201D40201003082015906092A864886F70D010703A082014A308201460201023182011730820113020102A0220420A6953E6E23C84DF0CA3F71311C667B32AD3EF9D8A1D2A0862CFB246A65EC9006300506032B65700481E23081DF020100302A300506032B6570032100A654BBFE38E1C560A0C35E3E2C02B601839A3AC36C4657F5046016E68F9BF6FA3018060728818C71020502300D060960864801650304020205003041300D06096086480165030402020500043013B582327ECC7B6391E166623118A65E1094538FE5C3D7C3F0F485FB26B11A2C0520C86C101D80DE53E1A9DED7E4C3693051301D060960864801650304012A0410D3F5AF35C92766FFFA6A71890C2C9B6504305DAEB2B35CE367446CCFC079E6B0B1E6131FC9576BBD651AE931C2BA8C79CBBE868A329C2DDB45D44D78024C24AA8582302606092A864886F70D0107013019060960864801650304012E040C2535508A144DC510628FD57BA0723170306E0C1556495247494C2D444154412D5349474E4154555245A25504533051300D060960864801650304020205000440D89A7967C64B0F51177BD426AA551C0545158DE25D6178BBEAEF2F722A7238A43B147BCDA80548F31095CA05DAB8201671D73AA55C6A984A6DB25458CA406E00".ToBytes();
			var publicKeyRecipient = Asn1Object.FromByteArray("30820113020102A0220420A6953E6E23C84DF0CA3F71311C667B32AD3EF9D8A1D2A0862CFB246A65EC9006300506032B65700481E23081DF020100302A300506032B6570032100A654BBFE38E1C560A0C35E3E2C02B601839A3AC36C4657F5046016E68F9BF6FA3018060728818C71020502300D060960864801650304020205003041300D06096086480165030402020500043013B582327ECC7B6391E166623118A65E1094538FE5C3D7C3F0F485FB26B11A2C0520C86C101D80DE53E1A9DED7E4C3693051301D060960864801650304012A0410D3F5AF35C92766FFFA6A71890C2C9B6504305DAEB2B35CE367446CCFC079E6B0B1E6131FC9576BBD651AE931C2BA8C79CBBE868A329C2DDB45D44D78024C24AA8582".ToBytes());
			var sign = "3051300D060960864801650304020205000440D89A7967C64B0F51177BD426AA551C0545158DE25D6178BBEAEF2F722A7238A43B147BCDA80548F31095CA05DAB8201671D73AA55C6A984A6DB25458CA406E00".ToBytes();
			var actual = new Envelope(new[]
				{
					publicKeyRecipient,
				},
new Nonce("2535508A144DC510628FD57B".ToBytes()),
				new Dictionary<string, object>
				{
					{"VIRGIL-DATA-SIGNATURE",sign }
				})
			.GetDerEncoded();

			Assert.Equal(expected, actual);
		}
	}
}